<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Irregular Verb Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Use Inter font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Tabs */
        .tabs { display:flex; gap:8px; margin-bottom:16px; }
        .tab-btn { padding:8px 12px; border-radius:8px; background:#f3f4f6; cursor:pointer; border:1px solid #e5e7eb; }
        .tab-btn.active { background:#1d4ed8; color:white; border-color:#1e40af; }
        /* Flashcard */
        .card-scene { perspective:1000px; }
        .card { width:100%; height:180px; position:relative; transform-style:preserve-3d; transition: transform 0.6s; cursor:pointer; }
        .card.is-flipped { transform: rotateY(180deg); }
        .card-face { position:absolute; inset:0; backface-visibility:hidden; display:flex; align-items:center; justify-content:center; padding:16px; border-radius:12px; box-shadow:0 6px 18px rgba(15,23,42,0.08); }
        .card-face.front { background:linear-gradient(180deg,#fff,#f8fafc); font-size:1.25rem; font-weight:600; color:#0f172a; }
        .card-face.back { background:linear-gradient(180deg,#f8fafc,#ffffff); transform:rotateY(180deg); font-size:1rem; color:#0f172a; }
        .flash-controls { display:flex; gap:8px; margin-top:12px; }
        /* Custom styles for input correctness */
        .correct {
            border-color: #22c55e; /* green-500 */
            background-color: #f0fdf4; /* green-50 */
        }
        .incorrect {
            border-color: #ef4444; /* red-500 */
            background-color: #fef2f2; /* red-50 */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg w-full max-w-md">
        <div class="tabs" role="tablist" aria-label="App tabs">
            <button id="tab-btn-irregular" class="tab-btn active" role="tab" aria-selected="true">Irregular Verbs</button>
            <button id="tab-btn-flash" class="tab-btn" role="tab" aria-selected="false">Flashcards</button>
        </div>

        <!-- Irregular verbs panel -->
        <div id="panel-irregular">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">
                Irregular Verb Practice
            </h1>

            <div id="error-container" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                <strong class="font-bold">Error:</strong>
                <span class="block sm:inline" id="error-message"></span>
            </div>

            <div id="verb-fields-container" class="space-y-4 mb-5">
                <div>
                    <label id="label-base" for="input-base" class="text-sm font-medium text-gray-600">Base Form (V1)</label>
                    <div id="container-base" class="mt-1"></div>
                </div>

                <div>
                    <label id="label-simple" for="input-simple" class="text-sm font-medium text-gray-600">Past Simple (V2)</label>
                    <div id="container-simple" class="mt-1"></div>
                </div>

                <div>
                    <label id="label-participle" for="input-participle" class="text-sm font-medium text-gray-600">Past Participle (V3)</label>
                    <div id="container-participle" class="mt-1"></div>
                </div>
            </div>

            <div id="feedback" class="mt-5 p-3 rounded-lg text-center font-medium hidden"></div>

            <div class="mt-6">
                <button id="check-btn" class="w-full bg-blue-600 text-white p-3 rounded-lg text-lg font-semibold hover:bg-blue-700 transition">
                    Check Answer
                </button>
                <button id="next-btn" class="w-full bg-gray-700 text-white p-3 rounded-lg text-lg font-semibold hover:bg-gray-800 transition hidden">
                    Next Question
                </button>
            </div>
        </div>

        <!-- Flashcards panel (hidden by default) -->
        <div id="panel-flashcards" class="hidden">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Flashcards - Use of English</h1>

            <div id="flash-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert"></div>

            <div class="card-scene">
                <div id="flash-card" class="card">
                    <div class="card-face front" id="card-front">...</div>
                    <div class="card-face back" id="card-back">...</div>
                </div>
            </div>

            <div class="flash-controls">
                <button id="btn-flip" class="tab-btn">Flip</button>
                <button id="btn-speak-flash" class="tab-btn" aria-label="Pronounce word" title="Pronounce word">ðŸ”Š</button>
                <button id="btn-next" class="tab-btn">âœ“ Next</button>
                <button id="btn-randomize" class="tab-btn">Shuffle</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const VERB_FILE = 'data/irregular-verbs.csv';

        // --- STATE ---
        let verbList = [];
        let currentVerb = {};
        let quizMode = 0; // 0: prompt base, 1: prompt simple, 2: prompt participle
        
        // Input elements will be dynamically created, so we declare them here
        let inputBase, inputSimple, inputParticiple; 

        // --- DOM ELEMENTS ---
        const appContainer = document.getElementById('app-container');
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        
        // NEW: Get containers and labels for the 3 fields
        const containerBase = document.getElementById('container-base');
        const containerSimple = document.getElementById('container-simple');
        const containerParticiple = document.getElementById('container-participle');
        
        const labelBase = document.getElementById('label-base');
        const labelSimple = document.getElementById('label-simple');
        const labelParticiple = document.getElementById('label-participle');

        const checkBtn = document.getElementById('check-btn');
        const nextBtn = document.getElementById('next-btn');
        const feedback = document.getElementById('feedback');

        // --- FUNCTIONS ---

        /**
         * Displays a fatal error message and hides the app.
         * (Unchanged)
         */
        function showFatalError(message) {
            appContainer.style.display = 'none'; // Hide the main app UI
            
            // Create a new error box to show outside the app container
            const errorBox = document.createElement('div');
            errorBox.className = "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl shadow-lg w-full max-w-md";
            errorBox.setAttribute('role', 'alert');
            errorBox.innerHTML = `
                <strong class="font-bold">App Failed to Load</strong>
                <p class="block mt-2">${message}</p>
                <p class="text-sm mt-2">
                    <strong>Note:</strong> If you are running this file locally (from <code>file:///</code>), 
                    it will not work due to browser security rules. You must use a local server.
                </p>
            `;
            document.body.appendChild(errorBox);
        }

        /**
         * Fetches and parses the CSV data into the verbList array.
         * (Unchanged)
         */
        async function loadAndParseCSV() {
            try {
                const response = await fetch(VERB_FILE);
                if (!response.ok) {
                    throw new Error(`Could not find '${VERB_FILE}'. Status: ${response.status}`);
                }
                const csvData = await response.text();
                
                const lines = csvData.trim().split('\n');
                if (lines.length <= 1) {
                    throw new Error("CSV file is empty or has no verb data.");
                }
                
                verbList = lines.slice(1).map(line => {
                    const values = line.split(',');
                    if (values.length >= 3) {
                        return {
                            base: values[0].trim(),
                            simple: values[1].trim(),
                            participle: values[2].trim()
                        };
                    }
                    return null; // Handle potentially empty or malformed lines
                }).filter(verb => verb !== null); // Filter out any bad lines

                if (verbList.length === 0) {
                     throw new Error("CSV file loaded, but no valid verb data was found.");
                }

            } catch (error) {
                console.error('Failed to load or parse CSV:', error);
                showFatalError(`Could not load or read <code>${VERB_FILE}</code>. <br> ${error.message}`);
            }
        }

        // --- NEW HELPER FUNCTIONS ---
        
        /**
         * Creates the HTML for an input field.
         * @param {string} id - The ID for the input element.
         * @param {string} placeholder - The placeholder text.
         * @returns {string} - The HTML string for the input.
         */
        function createInputHTML(id, placeholder) {
            return `<input type="text" id="${id}" class="block w-full p-3 border border-gray-300 rounded-lg text-lg" placeholder="${placeholder}">`;
        }

        /**
         * Creates the HTML for the prompt box.
         * @param {string} text - The verb text to display.
         * @returns {string} - The HTML string for the prompt.
         */
        function createPromptHTML(text) {
            return `
                <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                    <div id="prompt-verb" class="text-3xl font-bold text-blue-600 cursor-pointer" title="Click to hear pronunciation">
                        ${text}
                    </div>
                    <button id="speak-btn" class="p-2 rounded-full text-gray-500 hover:bg-gray-200 hover:text-blue-600 transition" aria-label="Pronounce word" title="Pronounce word">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707a1 1 0 011.707.707v14.586a1 1 0 01-1.707.707L5.586 15z" />
                        </svg>
                    </button>
                </div>
            `;
        }

        /**
         * Handles the Enter keypress on any input.
         */
        function handleEnter(e) {
            if (e.key === 'Enter') {
                checkBtn.click();
            }
        }

        // --- UPDATED FUNCTIONS ---

        /**
         * Loads a new random question.
         * (This function is heavily modified)
         */
        function loadQuestion() {
            // Pick a random verb and quiz mode
            currentVerb = verbList[Math.floor(Math.random() * verbList.length)];
            quizMode = Math.floor(Math.random() * 3);

            // Reset UI
            feedback.classList.add('hidden');
            checkBtn.classList.remove('hidden');
            nextBtn.classList.add('hidden');

            // Reset labels to default style
            labelBase.className = 'text-sm font-medium text-gray-600';
            labelSimple.className = 'text-sm font-medium text-gray-600';
            labelParticiple.className = 'text-sm font-medium text-gray-600';

            // Dynamically build the UI based on the quiz mode
            switch (quizMode) {
                case 0: // Prompt with Base Form
                    containerBase.innerHTML = createPromptHTML(currentVerb.base);
                    containerSimple.innerHTML = createInputHTML('input-simple', 'Enter past simple...');
                    containerParticiple.innerHTML = createInputHTML('input-participle', 'Enter past participle...');
                    labelBase.className += ' text-blue-600 font-bold'; // Highlight prompt label
                    break;
                case 1: // Prompt with Past Simple
                    containerBase.innerHTML = createInputHTML('input-base', 'Enter base form...');
                    containerSimple.innerHTML = createPromptHTML(currentVerb.simple);
                    containerParticiple.innerHTML = createInputHTML('input-participle', 'Enter past participle...');
                    labelSimple.className += ' text-blue-600 font-bold'; // Highlight prompt label
                    break;
                case 2: // Prompt with Past Participle
                    containerBase.innerHTML = createInputHTML('input-base', 'Enter base form...');
                    containerSimple.innerHTML = createInputHTML('input-simple', 'Enter past simple...');
                    containerParticiple.innerHTML = createPromptHTML(currentVerb.participle);
                    labelParticiple.className += ' text-blue-600 font-bold'; // Highlight prompt label
                    break;
            }

            // --- Re-select inputs and add listeners ---
            
            // 1. Get references to the newly created inputs (some will be null)
            inputBase = document.getElementById('input-base');
            inputSimple = document.getElementById('input-simple');
            inputParticiple = document.getElementById('input-participle');

            // 2. Add 'Enter' key listener to whichever inputs exist
            if (inputBase) inputBase.addEventListener('keypress', handleEnter);
            if (inputSimple) inputSimple.addEventListener('keypress', handleEnter);
            if (inputParticiple) inputParticiple.addEventListener('keypress', handleEnter);

            // 3. Add listeners for the new speak button and prompt text
            // (These elements only exist in the "prompt" slot)
            const speakBtn = document.getElementById('speak-btn');
            const promptVerb = document.getElementById('prompt-verb');
            if (speakBtn && promptVerb) {
                speakBtn.addEventListener('click', speakWord);
                promptVerb.addEventListener('click', speakWord);
            }
        }

        /**
         * Checks if a user's answer matches one of the possible correct answers.
         * (Unchanged)
         */
        function isAnswerCorrect(userInput, correctAnswers) {
            if (userInput === null || userInput === undefined) return false; // Handle null inputs
            const normalizedInput = userInput.trim().toLowerCase();
            const possibleAnswers = correctAnswers.split('/').map(ans => ans.toLowerCase());
            return possibleAnswers.includes(normalizedInput);
        }
        
        /**
         * Pronounces the text in the prompt-verb element.
         * (Unchanged - it finds the element with id="prompt-verb", which we create)
         */
        function speakWord() {
            // Find the prompt-verb element, which is dynamically created
            const promptVerb = document.getElementById('prompt-verb');
            if (!promptVerb) return; // Safety check
            
            const textToSpeak = promptVerb.textContent;
            if (!textToSpeak || textToSpeak === '...') {
                return; // Don't speak if loading
            }

            // Check for browser support
            if (!('speechSynthesis' in window)) {
                alert('Sorry, your browser does not support speech synthesis.');
                return;
            }

            // Clean up text (e.g., "burnt/burned" -> "burnt")
            const cleanedText = textToSpeak.split('/')[0].trim();

            const utterance = new SpeechSynthesisUtterance(cleanedText);
            utterance.lang = 'en-US'; // Set language for correct accent
            window.speechSynthesis.speak(utterance);
        }

        /**
         * Checks the user's answers and provides feedback.
         * (This function is heavily modified)
         */
        function checkAnswer() {
            let allCorrect = true;

            // Check each field only if it was an input (i.e., not the prompt)
            
            if (quizMode !== 0) { // Base form was an input
                const correct = isAnswerCorrect(inputBase.value, currentVerb.base);
                inputBase.classList.toggle('correct', correct);
                inputBase.classList.toggle('incorrect', !correct);
                inputBase.disabled = true;
                if (!correct) allCorrect = false;
            }

            if (quizMode !== 1) { // Past Simple was an input
                const correct = isAnswerCorrect(inputSimple.value, currentVerb.simple);
                inputSimple.classList.toggle('correct', correct);
                inputSimple.classList.toggle('incorrect', !correct);
                inputSimple.disabled = true;
                if (!correct) allCorrect = false;
            }

            if (quizMode !== 2) { // Past Participle was an input
                const correct = isAnswerCorrect(inputParticiple.value, currentVerb.participle);
                inputParticiple.classList.toggle('correct', correct);
                inputParticiple.classList.toggle('incorrect', !correct);
                inputParticiple.disabled = true;
                if (!correct) allCorrect = false;
            }

            // Show feedback message
            feedback.classList.remove('hidden');
            if (allCorrect) {
                feedback.textContent = 'Correct! Well done.';
                feedback.className = 'mt-5 p-3 rounded-lg text-center font-medium bg-green-100 text-green-800';
            } else {
                // Always show the full, correct answer on failure
                feedback.innerHTML = `
                    Not quite. The correct forms are: <br>
                    <strong>${currentVerb.base} / ${currentVerb.simple} / ${currentVerb.participle}</strong>
                `;
                feedback.className = 'mt-5 p-3 rounded-lg text-center font-medium bg-red-100 text-red-800';
            }

            // Toggle buttons
            checkBtn.classList.add('hidden');
            nextBtn.classList.remove('hidden');
        }

        // --- INITIALIZATION ---
        // (Modified to remove listeners for elements that are now dynamic)
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAndParseCSV(); 
            
            if (verbList.length > 0) {
                // Load the first question (which will also set up all dynamic listeners)
                loadQuestion();

                checkBtn.addEventListener('click', checkAnswer);
                nextBtn.addEventListener('click', loadQuestion);
                
                // Note: Listeners for inputs, speakBtn, and promptVerb
                // are now added INSIDE the loadQuestion() function
                // because those elements are created dynamically.
            }
        });

        // --- Flashcards / Tabs ---
        const USE_FILE = 'data/use-of-english.csv';
        const USE_FALLBACK = 'data/use-of-english - all.csv';
        let flashList = [];
        let flashIndex = 0;
        const panelIrregular = document.getElementById('panel-irregular');
        const panelFlash = document.getElementById('panel-flashcards');
        const tabBtnIrregular = document.getElementById('tab-btn-irregular');
        const tabBtnFlash = document.getElementById('tab-btn-flash');

        const flashCard = document.getElementById('flash-card');
        const cardFront = document.getElementById('card-front');
        const cardBack = document.getElementById('card-back');
        const btnFlip = document.getElementById('btn-flip');
        const btnSpeak = document.getElementById('btn-speak-flash');
        const btnNext = document.getElementById('btn-next');
        const btnShuffle = document.getElementById('btn-randomize');
        const flashError = document.getElementById('flash-error');

        function switchToTab(tabName) {
            if (tabName === 'flash') {
                panelIrregular.classList.add('hidden');
                panelFlash.classList.remove('hidden');
                tabBtnFlash.classList.add('active');
                tabBtnIrregular.classList.remove('active');
            } else {
                panelIrregular.classList.remove('hidden');
                panelFlash.classList.add('hidden');
                tabBtnFlash.classList.remove('active');
                tabBtnIrregular.classList.add('active');
            }
        }

        async function loadUseCSV() {
            flashError.classList.add('hidden');
            flashList = [];
            try {
                let res = await fetch(USE_FILE);
                if (!res.ok) {
                    // try fallback
                    res = await fetch(USE_FALLBACK);
                    if (!res.ok) throw new Error('Could not load use-of-english CSV');
                }
                const txt = await res.text();
                const lines = txt.trim().split(/\r?\n/).filter(l => l.trim());
                for (const line of lines) {
                    // split at first comma
                    const idx = line.indexOf(',');
                    if (idx === -1) continue;
                    const term = line.slice(0, idx).trim();
                    const def = line.slice(idx + 1).trim();
                    if (term) flashList.push({term, def});
                }
                if (flashList.length === 0) throw new Error('No flashcards parsed');
                shuffleFlashcards();
                flashIndex = 0;
                showFlashcard(flashIndex);
            } catch (err) {
                console.error('Flashcards load error', err);
                flashError.textContent = 'Could not load flashcards: ' + err.message;
                flashError.classList.remove('hidden');
            }
        }

        function showFlashcard(i) {
            if (!flashList.length) return;
            const item = flashList[i % flashList.length];
            cardFront.textContent = item.term;
            cardBack.textContent = item.def;
            flashCard.classList.remove('is-flipped');
        }

        function flipFlashcard() {
            flashCard.classList.toggle('is-flipped');
        }

        function speakFlashcard() {
            if (!cardFront) return;
            const text = cardFront.textContent || '';
            const cleaned = text.split('/')[0].trim();
            if (!cleaned) return;
            if (!('speechSynthesis' in window)) {
                alert('Sorry, your browser does not support speech synthesis.');
                return;
            }
            const u = new SpeechSynthesisUtterance(cleaned);
            u.lang = 'en-US';
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(u);
        }

        function nextFlashcard() {
            flashIndex = (flashIndex + 1) % flashList.length;
            showFlashcard(flashIndex);
        }

        function shuffleFlashcards() {
            for (let i = flashList.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [flashList[i], flashList[j]] = [flashList[j], flashList[i]];
            }
        }

        // Wire up tab and flash controls after DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            tabBtnIrregular.addEventListener('click', () => switchToTab('irregular'));
            tabBtnFlash.addEventListener('click', async () => {
                switchToTab('flash');
                if (flashList.length === 0) await loadUseCSV();
            });

            if (flashCard) flashCard.addEventListener('click', flipFlashcard);
            if (btnFlip) btnFlip.addEventListener('click', flipFlashcard);
            if (btnSpeak) btnSpeak.addEventListener('click', (e) => { e.stopPropagation(); speakFlashcard(); });
            if (btnNext) btnNext.addEventListener('click', nextFlashcard);
            if (btnShuffle) btnShuffle.addEventListener('click', () => { shuffleFlashcards(); flashIndex = 0; showFlashcard(flashIndex); });
        });
    </script>
</body>
</html>